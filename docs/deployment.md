# 部署文档

本文档描述了塔罗牌小程序的部署流程、环境配置和发布步骤。

## 部署环境

### 开发环境

- **环境标识**：dev
- **服务器**：腾讯云开发环境
- **数据库**：云开发数据库(开发环境)
- **存储**：云开发存储(开发环境)
- **小程序AppID**：wxXXXXXXXXXXXXXXXX (开发版本)
- **域名**：dev-tarot.example.com

### 测试环境

- **环境标识**：test
- **服务器**：腾讯云开发环境
- **数据库**：云开发数据库(测试环境)
- **存储**：云开发存储(测试环境)
- **小程序AppID**：wxXXXXXXXXXXXXXXXX (体验版本)
- **域名**：test-tarot.example.com

### 生产环境

- **环境标识**：prod
- **服务器**：腾讯云开发环境
- **数据库**：云开发数据库(生产环境)
- **存储**：云开发存储(生产环境)
- **小程序AppID**：wxXXXXXXXXXXXXXXXX (正式版本)
- **域名**：tarot.example.com

## 部署准备

### 环境配置

1. **微信公众平台配置**
   - 登录[微信公众平台](https://mp.weixin.qq.com/)
   - 完成小程序信息配置
   - 配置服务器域名白名单
   - 申请并配置相关API权限

2. **云开发环境配置**
   - 创建对应环境的云开发环境
   - 设置数据库集合和权限
   - 配置存储桶和权限
   - 部署云函数

3. **准备环境变量文件**

   为不同环境创建配置文件：

   ```bash
   # .env.dev
   CLOUD_ENV=dev-env-xxxxx
   API_BASE_URL=https://dev-api.tarot-app.com
   ```

   ```bash
   # .env.test
   CLOUD_ENV=test-env-xxxxx
   API_BASE_URL=https://test-api.tarot-app.com
   ```

   ```bash
   # .env.prod
   CLOUD_ENV=prod-env-xxxxx
   API_BASE_URL=https://api.tarot-app.com
   ```

## 构建部署流程

### 1. 准备构建

1. **安装依赖**

   ```bash
   npm install
   ```

2. **静态资源检查**

   ```bash
   # 检查图片优化情况
   npm run check:images
   
   # 检查资源引用
   npm run check:assets
   ```

3. **代码检查**

   ```bash
   # 运行代码质量检查
   npm run lint
   
   # 运行类型检查(TypeScript)
   npm run type-check
   ```

### 2. 构建流程

#### 开发环境构建

```bash
# 设置环境变量
export NODE_ENV=development

# 执行构建
npm run build:mp-weixin -- --env dev
```

#### 测试环境构建

```bash
# 设置环境变量
export NODE_ENV=test

# 执行构建
npm run build:mp-weixin -- --env test
```

#### 生产环境构建

```bash
# 设置环境变量
export NODE_ENV=production

# 执行构建
npm run build:mp-weixin -- --env prod
```

### 3. 部署流程

#### 微信开发者工具部署

1. **打开微信开发者工具**

2. **导入项目**
   - 选择构建输出目录 `dist/build/mp-weixin`
   - 设置AppID

3. **上传代码**
   - 点击"上传"按钮
   - 填写版本号和项目备注
   - 选择开发环境

4. **提交审核**
   - 在微信公众平台提交审核
   - 填写审核材料

5. **发布版本**
   - 审核通过后发布正式版本

#### 自动化部署脚本

可以创建部署脚本简化流程：

```bash
#!/bin/bash
# deploy.sh

# 获取部署环境参数
ENV=$1
VERSION=$2

if [ -z "$ENV" ] || [ -z "$VERSION" ]; then
  echo "Usage: ./deploy.sh [dev|test|prod] [version]"
  exit 1
fi

# 设置环境变量
export NODE_ENV=$ENV

# 安装依赖
npm install

# 代码检查
npm run lint
npm run type-check

# 执行构建
npm run build:mp-weixin -- --env $ENV

# 执行微信小程序CLI上传
npx miniprogram-ci upload --pp ./dist/build/mp-weixin --pkp ./private.key --appid wxXXXXXXXXXXXXXXXX --uv $VERSION --desc "自动部署 - $ENV 环境"

echo "部署完成: $ENV 环境, 版本号: $VERSION"
```

使用方式：

```bash
# 部署到开发环境
./deploy.sh dev 1.0.0

# 部署到测试环境
./deploy.sh test 1.0.0

# 部署到生产环境
./deploy.sh prod 1.0.0
```

## 微信小程序发布流程

### 1. 版本管理

- **版本号规范**：遵循语义化版本(Semantic Versioning)
  - 主版本号.次版本号.修订号 (如 1.2.3)
  - 主版本号：不兼容的API修改
  - 次版本号：向下兼容的功能性新增
  - 修订号：向下兼容的问题修正

- **发布周期**：
  - 每两周发布一个次版本
  - 紧急问题修复可随时发布修订版本
  - 重大功能更新发布主版本

### 2. 审核提交材料准备

- **小程序介绍**：简要描述小程序功能和用途
- **测试账号**：提供测试账号和密码
- **测试说明**：详细的测试路径和操作步骤
- **特殊权限说明**：如需要位置、相机等特殊权限的说明
- **资质材料**：如需要的特殊类目资质证明

### 3. 审核流程

1. **预审核**：
   - 团队内部测试验收
   - 检查功能完整性
   - 验证审核可能关注的问题点

2. **提交审核**：
   - 登录微信公众平台
   - 选择"版本管理"
   - 点击"提交审核"
   - 填写版本信息
   - 上传审核材料

3. **审核跟踪**：
   - 定期检查审核状态
   - 准备应对审核反馈

4. **审核通过后**：
   - 进行最终测试验证
   - 准备发布计划

### 4. 正式发布

1. **灰度发布**：
   - 设置发布比例 (如10%、50%用户)
   - 观察用户反馈
   - 监控系统稳定性

2. **全量发布**：
   - 确认灰度期间无重大问题
   - 执行全量发布
   - 更新版本日志

3. **发布后监控**：
   - 监控用户使用情况
   - 收集用户反馈
   - 处理可能出现的问题

## 服务器环境配置

### 云开发环境

1. **创建云开发环境**：
   - 登录微信公众平台
   - 进入"开发"->"开发设置"->"云开发"
   - 创建对应环境(开发/测试/生产)

2. **数据库配置**：
   - 创建所需数据集合
   - 设置集合的读写权限
   - 创建索引优化查询性能

3. **存储空间配置**：
   - 创建存储桶
   - 设置存储桶权限
   - 配置CDN加速(生产环境)

4. **云函数部署**：
   - 部署业务逻辑云函数
   - 设置云函数触发器
   - 配置云函数环境变量

### 安全配置

1. **数据安全**：
   - 敏感数据加密存储
   - 合理设置数据库权限
   - 定期数据备份

2. **API安全**：
   - 启用HTTPS
   - 实现请求签名机制
   - 设置合理的请求频率限制

3. **鉴权安全**：
   - 实现严格的Token验证
   - 合理设置Token过期时间
   - 敏感操作二次验证

## 部署检查清单

在完成部署前，请检查以下事项：

- [ ] 所有必要的云开发资源已配置
- [ ] 环境变量文件已正确配置
- [ ] 代码库中不包含敏感信息(密钥、密码等)
- [ ] 完成了所有代码质量检查
- [ ] 已运行并通过自动化测试
- [ ] 已完成手动功能测试
- [ ] 已准备好审核所需材料
- [ ] 已更新版本号和变更日志
- [ ] 准备了回滚方案

## 部署问题排查

### 常见问题及解决方案

1. **构建失败**
   - 检查依赖版本兼容性
   - 检查构建脚本配置
   - 检查环境变量设置

2. **上传失败**
   - 确认开发者工具版本是否最新
   - 检查网络连接
   - 验证项目配置和AppID

3. **审核被拒**
   - 仔细阅读拒绝原因
   - 根据反馈修改问题
   - 完善审核材料后重新提交

4. **线上功能异常**
   - 检查云开发环境配置
   - 查看云函数日志
   - 确认API接口是否正常

## 回滚方案

### 紧急回滚步骤

1. **版本回滚**：
   - 登录微信公众平台
   - 进入"版本管理"
   - 选择上一个稳定版本
   - 点击"回退版本"

2. **数据回滚**：
   - 使用备份数据恢复
   - 执行数据修复脚本
   - 验证数据一致性

3. **通知用户**：
   - 发布公告说明情况
   - 提供临时解决方案
   - 说明修复计划和时间 